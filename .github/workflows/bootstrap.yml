name: Bootstrap OIDC and IAM

on:
  workflow_dispatch:

env:
  AWS_REGION: eu-west-2
  TERRAFORM_VERSION: 1.6.0

jobs:
  bootstrap-iam:
    name: Bootstrap IAM and OIDC Provider
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (Access Keys)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Ensure S3 backend exists
        run: |
          BUCKET_NAME="aimapp-terraform-state-147923156682"
          DYNAMODB_TABLE="terraform-state-lock"
          
          echo "Checking S3 bucket..."
          if aws s3api head-bucket --bucket "$BUCKET_NAME" --region ${{ env.AWS_REGION }} 2>/dev/null; then
            echo "S3 bucket already exists"
          else
            echo "Creating S3 bucket for Terraform state..."
            aws s3 mb "s3://$BUCKET_NAME" --region ${{ env.AWS_REGION }}
            aws s3api put-bucket-versioning \
              --bucket "$BUCKET_NAME" \
              --versioning-configuration Status=Enabled \
              --region ${{ env.AWS_REGION }}
            echo "S3 bucket created successfully"
          fi
          
          echo "Verifying S3 bucket access..."
          aws s3api head-bucket --bucket "$BUCKET_NAME" --region ${{ env.AWS_REGION }}
          
          echo "Checking DynamoDB table..."
          TABLE_EXISTS=$(aws dynamodb describe-table --table-name "$DYNAMODB_TABLE" --region ${{ env.AWS_REGION }} --query 'Table.TableStatus' --output text 2>/dev/null || echo "NOT_FOUND")
          
          if [ "$TABLE_EXISTS" = "NOT_FOUND" ] || [ -z "$TABLE_EXISTS" ]; then
            echo "Creating DynamoDB table for state locking..."
            aws dynamodb create-table \
              --table-name "$DYNAMODB_TABLE" \
              --attribute-definitions AttributeName=LockID,AttributeType=S \
              --key-schema AttributeName=LockID,KeyType=HASH \
              --billing-mode PAY_PER_REQUEST \
              --region ${{ env.AWS_REGION }}
            echo "Waiting for DynamoDB table to be active..."
            aws dynamodb wait table-exists --table-name "$DYNAMODB_TABLE" --region ${{ env.AWS_REGION }}
            echo "DynamoDB table created successfully"
          else
            echo "DynamoDB table already exists, waiting for active status..."
            aws dynamodb wait table-exists --table-name "$DYNAMODB_TABLE" --region ${{ env.AWS_REGION }}
          fi
          
          echo "Verifying DynamoDB table is active..."
          TABLE_STATUS=$(aws dynamodb describe-table --table-name "$DYNAMODB_TABLE" --region ${{ env.AWS_REGION }} --query 'Table.TableStatus' --output text)
          echo "DynamoDB table status: $TABLE_STATUS"
          
          if [ "$TABLE_STATUS" != "ACTIVE" ]; then
            echo "ERROR: DynamoDB table is not active"
            exit 1
          fi
          
          echo "âœ… Backend resources verified and ready"

      - name: Verify backend permissions
        run: |
          BUCKET_NAME="aimapp-terraform-state-147923156682"
          DYNAMODB_TABLE="terraform-state-lock"
          
          echo "Testing S3 bucket access..."
          echo "test" | aws s3 cp - "s3://$BUCKET_NAME/test.txt" --region ${{ env.AWS_REGION }}
          aws s3 rm "s3://$BUCKET_NAME/test.txt" --region ${{ env.AWS_REGION }}
          echo "âœ… S3 bucket access verified"
          
          echo "Testing DynamoDB table access..."
          aws dynamodb put-item \
            --table-name "$DYNAMODB_TABLE" \
            --item '{"LockID": {"S": "test-lock"}}' \
            --region ${{ env.AWS_REGION }}
          aws dynamodb delete-item \
            --table-name "$DYNAMODB_TABLE" \
            --key '{"LockID": {"S": "test-lock"}}' \
            --region ${{ env.AWS_REGION }}
          echo "âœ… DynamoDB table access verified"

      - name: Bootstrap IAM (OIDC Provider + IAM Role)
        run: |
          set -e
          cd infra
          
          echo "Cleaning up any existing Terraform files..."
          rm -rf .terraform .terraform.lock.hcl terraform.tfstate terraform.tfstate.* 2>/dev/null || true
          
          echo "Verifying backend resources exist..."
          aws s3api head-bucket --bucket aimapp-terraform-state-147923156682 --region ${{ env.AWS_REGION }} || {
            echo "ERROR: S3 bucket does not exist or is not accessible"
            exit 1
          }
          
          aws dynamodb describe-table --table-name terraform-state-lock --region ${{ env.AWS_REGION }} --query 'Table.TableStatus' --output text || {
            echo "ERROR: DynamoDB table does not exist or is not accessible"
            exit 1
          }
          
          echo "Checking backend configuration..."
          grep -A 10 "backend" main.tf
          
          echo "Initializing Terraform with S3 backend..."
          echo "Running terraform init with -reconfigure flag..."
          terraform init -reconfigure -input=false -upgrade 2>&1 | tee /tmp/terraform-init.log
          
          INIT_EXIT_CODE=${PIPESTATUS[0]}
          echo "::notice::Terraform init exit code: $INIT_EXIT_CODE"
          
          if [ $INIT_EXIT_CODE -ne 0 ]; then
            echo "::error::Terraform init failed with exit code $INIT_EXIT_CODE"
            echo "## âŒ Terraform Init Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Terraform Init Output:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat /tmp/terraform-init.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Diagnostics:" >> $GITHUB_STEP_SUMMARY
            echo "- **Terraform Version:**" >> $GITHUB_STEP_SUMMARY
            terraform version >> $GITHUB_STEP_SUMMARY
            echo "- **AWS Credentials:**" >> $GITHUB_STEP_SUMMARY
            aws sts get-caller-identity >> $GITHUB_STEP_SUMMARY
            echo "- **S3 Backend Access:**" >> $GITHUB_STEP_SUMMARY
            aws s3 ls s3://aimapp-terraform-state-147923156682/ >> $GITHUB_STEP_SUMMARY 2>&1 || echo "S3 bucket is empty (this is OK)" >> $GITHUB_STEP_SUMMARY
            echo "- **DynamoDB Table:**" >> $GITHUB_STEP_SUMMARY
            aws dynamodb describe-table --table-name terraform-state-lock --region ${{ env.AWS_REGION }} >> $GITHUB_STEP_SUMMARY 2>&1 || echo "DynamoDB table check failed" >> $GITHUB_STEP_SUMMARY
            echo "- **Backend Configuration:**" >> $GITHUB_STEP_SUMMARY
            echo '```terraform' >> $GITHUB_STEP_SUMMARY
            grep -A 10 "backend" main.tf >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Full Terraform Init Output:" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>Click to expand</summary>" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat /tmp/terraform-init.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          echo "::notice::Terraform init completed successfully"
          echo "## âœ… Terraform Init Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Init Output:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat /tmp/terraform-init.log | tail -20 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          echo "Verifying backend initialization..."
          if [ ! -d ".terraform" ]; then
            echo "ERROR: .terraform directory was not created"
            exit 1
          fi
          
          echo "Checking .terraform directory contents..."
          ls -la .terraform/
          
          echo "Checking for backend configuration..."
          if [ -f ".terraform/terraform.tfstate" ]; then
            echo "Backend state file exists"
            cat .terraform/terraform.tfstate | head -20
          else
            echo "No backend state file (first run - this is OK)"
          fi
          
          echo "Checking backend configuration in .terraform directory..."
          if [ -d ".terraform/backend" ]; then
            echo "Backend directory exists"
            ls -la .terraform/backend/
          else
            echo "WARNING: Backend directory not found - checking if backend was initialized..."
          fi
          
          echo "Verifying backend connection with terraform state list..."
          if terraform state list 2>&1 | head -5; then
            echo "âœ… Backend connection verified (state exists)"
          else
            EXIT_CODE=$?
            if [ $EXIT_CODE -eq 1 ]; then
              echo "âœ… Backend connection verified (empty state - first run, exit code 1 is expected)"
            else
              echo "ERROR: terraform state list failed with exit code $EXIT_CODE"
              echo "This might indicate a backend initialization issue"
            fi
          fi
          
          echo "Running terraform plan..."
          if ! terraform plan -target=module.iam -input=false -out=tfplan; then
            echo "ERROR: terraform plan failed"
            echo "Checking backend status..."
            terraform version
            ls -la .terraform/
            cat .terraform/terraform.tfstate 2>/dev/null || echo "No local backend state file"
            exit 1
          fi
          
          echo "Applying IAM module..."
          if ! terraform apply -input=false tfplan; then
            echo "ERROR: terraform apply failed"
            exit 1
          fi
          
          echo "âœ… IAM module applied successfully"
          
      - name: Get IAM Role ARN
        id: get-role-arn
        run: |
          cd infra
          ROLE_ARN=$(aws iam get-role --role-name aimapp-github-actions-role --region ${{ env.AWS_REGION }} --query 'Role.Arn' --output text 2>/dev/null || echo "")
          if [ -z "$ROLE_ARN" ]; then
            echo "Error: Could not retrieve IAM role ARN"
            exit 1
          fi
          echo "role_arn=$ROLE_ARN" >> $GITHUB_OUTPUT
          echo "IAM Role ARN: $ROLE_ARN"
          
      - name: Bootstrap Complete Summary
        run: |
          echo "## âœ… Bootstrap Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**IAM Role ARN:** \`${{ steps.get-role-arn.outputs.role_arn }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Copy the IAM Role ARN above: \`${{ steps.get-role-arn.outputs.role_arn }}\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Go to **Repository Settings â†’ Secrets and variables â†’ Actions**" >> $GITHUB_STEP_SUMMARY
          echo "3. Click **New repository secret**" >> $GITHUB_STEP_SUMMARY
          echo "4. Name: \`AWS_GITHUB_ACTIONS_ROLE_ARN\`" >> $GITHUB_STEP_SUMMARY
          echo "5. Value: \`${{ steps.get-role-arn.outputs.role_arn }}\`" >> $GITHUB_STEP_SUMMARY
          echo "6. Click **Add secret**" >> $GITHUB_STEP_SUMMARY
          echo "7. After setting the secret, your main CI/CD workflow will work automatically!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”’ Protection Enabled" >> $GITHUB_STEP_SUMMARY
          echo "The OIDC provider and IAM role are protected from accidental deletion." >> $GITHUB_STEP_SUMMARY
          echo "You can now run \`terraform destroy\` safely - these resources will remain." >> $GITHUB_STEP_SUMMARY

